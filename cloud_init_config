#cloud-config
package_update: true
package_upgrade: true

disable_root: false
disable_root_opts: "permitrootlogin yes"
ssh_pwauth: false

ssh_authorized_keys:
  - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIM28nVX0GneGcVkD/GiwwOro1RNNHIhO76+6eGOHkM0H sergio@xps

write_files:
  - path: /etc/fail2ban/fail2ban.conf
    content: |
      [Definition]
      loglevel = 4
      logtarget = /var/log/fail2ban.log
      maxretry = 3
      bantime = 600
      findtime = 600
      mode = normal
      maxretry = 5

      [sshd]
      enabled = true
      port = 22
      logpath = /var/log/auth.log
      maxretry = 3

  - path: /etc/zsh/zshrc
    content: |
      export LANG=en_US.UTF-8
      export LC_ALL=en_US.UTF-8
      export EDITOR=vim
      export VISUAL=vim
      export HISTFILE=~/.zsh_history
      export HISTSIZE=1000
      export SAVEHIST=1000

  - path: /root/.oh-my-zsh
    content: |
      # Add Oh My Zsh configuration
      export ZSH_THEME="agnoster"
      export plugins=(zsh-syntax-highlighting)

  - path: /letsencrypt/acme.json
    permissions: '0600'
    owner: root:root

  - path: /etc/cron.daily/mawidabp-backups
    content: |
      #!/bin/sh
      set -eu

      rundate=`date '+%Y%m%d'`

      backup_dir=/var/backups/mawidabp.com/
      storage_dir=/private/

      backup_db=mawidabp_production
      backup_file=${backup_db}_${rundate}.sql.bz2

      s3_folder=kamal-audit
      s3_db_dir=db
      s3_storage_dir=private

      s3_bucket_name=customer-backups.hullop.com

      s3_db_bucket_url=s3://$s3_bucket_name/$s3_folder/$s3_db_dir/
      s3_storage_bucket_url=s3://$s3_bucket_name/$s3_folder/$s3_storage_dir/

      mkdir -p $backup_dir

      find $backup_dir -mindepth 1 -mtime +29 -delete

      # BACKUP
      docker exec -i mawidabp-postgresql /usr/bin/pg_dump -U mawidabp mawidabp_production | bzip2 > /var/tmp/$backup_file
      mv /var/tmp/$backup_file $backup_dir

      # S3 SYNC
      for cfg_path in $(ls ~/.s3cfg/*.s3cfg)
      do
        s3cmd sync $backup_dir  $s3_db_bucket_url      -c $cfg_path
        s3cmd sync $storage_dir $s3_storage_bucket_url -c $cfg_path
      done
    permissions: '0755'

packages:
  - fail2ban
  - zsh
  - docker.io
  - s3cmd
  - git

runcmd:
  - echo "alias ll='ls -l'" >> /root/.zshrc
  - service fail2ban start
  - service ssh restart
  - iptables -t filter -N FWR
  - iptables -t filter -A INPUT -j FWR
  - iptables -t filter -A FWR -i lo -j ACCEPT
  - iptables -t filter -A FWR -m state --state RELATED,ESTABLISHED -j ACCEPT
  - iptables -t filter -A FWR -p icmp -j ACCEPT
  - iptables -t filter -A FWR -p tcp --dport 22 -j ACCEPT
  - iptables -t filter -A FWR -p tcp --dport 80 -j ACCEPT
  - iptables -t filter -A FWR -p tcp --dport 443 -j ACCEPT
  - iptables -t filter -A FWR -p tcp --dport 8443 -j ACCEPT
  - iptables -t filter -A FWR -p tcp -m tcp --tcp-flags SYN,RST,ACK SYN -j REJECT --reject-with icmp-port-unreachable
  - iptables -t filter -A FWR -p udp -j REJECT --reject-with icmp-port-unreachable
