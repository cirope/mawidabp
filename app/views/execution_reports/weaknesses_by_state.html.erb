<%= render :partial => 'shared/filter_form',
  :locals => {:action => :weaknesses_by_state, :extra_params => {},
  :forms => {:date_range => {:avoid_inline_help => true}}} %>

<%  @counts.each do |count_data| %>
  <h1 class="simple_title with_border_bottom">
    <strong><%= Period.model_name.human %>: <%= count_data[:period].inspect %></strong>
  </h1>
  <% @audit_types.each do |type| %>
    <h1 class="center_title">
      <%= t "execution_reports.findings_type_#{type}" %>
    </h1>
    <% if count_data[:counts][type] %>
      <% count_data[:counts][type].each do |review, counts| %>
        <% weaknesses_count = counts[:weaknesses] %>
        <% oportunities_count = counts[:oportunities] %>
        <% total_weaknesses = weaknesses_count.values.sum %>
        <% total_oportunities = oportunities_count.values.sum %>
        <div style="margin: 1em;">
          <h2><%= "#{Review.model_name.human}: #{review}" %></h2>
        </div>

        <% unless (total_weaknesses + total_oportunities) == 0 %>
          <table class="summary_table" style="margin: 1em;">
            <thead>
              <tr>
                <th style="width: 30%;">
                  <%= Finding.human_attribute_name 'state' %>
                </th>
                <% if type == :internal %>
                  <th style="width: 35%;">
                    <%= t 'execution_reports.weaknesses_by_state.weaknesses_column' %>
                  </th>
                  <th style="width: 35%;">
                    <%= t 'execution_reports.weaknesses_by_state.oportunities_column' %>
                  </th>
                <% else %>
                  <th style="width: 70%;">
                    <%= t 'execution_reports.weaknesses_by_state.weaknesses_column' %>
                  </th>
                <% end %>
              </tr>
            </thead>
            <tbody>
              <% @status.each do |state| %>
                <% w_count = weaknesses_count[state.last] || 0 %>
                <% o_count = oportunities_count[state.last] || 0 %>
                <% weaknesses_percentage = total_weaknesses > 0 ? w_count.to_f / total_weaknesses * 100 : 0.0 %>
                <% oportunities_percentage = total_oportunities > 0 ? o_count.to_f / total_oportunities * 100 : 0.0 %>
                <tr>
                  <td><strong><%= t "finding.status_#{state.first}" %></strong></td>
                  <td><%= "#{w_count} (#{'%.2f' % weaknesses_percentage.round(2)}%)" %></td>
                  <% if type == :internal %>
                    <td><%= "#{o_count} (#{'%.2f' % oportunities_percentage.round(2)}%)" %></td>
                  <% end %>
                </tr>
              <% end %>
              <tr>
                <td>
                  <strong><%= t 'execution_reports.weaknesses_by_state.total' %></strong>
                </td>
                <td><strong><%= total_weaknesses %></strong></td>
                <% if type == :internal %>
                  <td><strong><%= total_oportunities %></strong></td>
                <% end %>
              </tr>
            </tbody>
          </table>
        <% else %>
          <p style="margin: 1em;">
            <em><%= t 'execution_reports.without_findings' %></em>
          </p>
        <% end %>
      <% end %>
    <% else %>
      <p style="margin: 1em;">
        <em><%= t 'execution_reports.without_weaknesses' %></em>
      </p>
    <% end %>
  <% end %>
<% end %>
<% if @counts.empty? %>
  <p style="margin: 2em 1em; font-size: 1.2em;">
    <em><%= t 'execution_reports.without_weaknesses_in_the_interval' %></em>
  </p>
<% end %>

<div id="links">
  <%= link_to t('label.back'), :action => :index %> |
  <%= link_to t('label.download'), '#', :onclick =>
    "Helper.showItem('#customize_report_form'); return false;" %>
</div>
<div id="customize_report_form" style="display: none;">
  <div>
  <%= render :partial => 'shared/customize_report_form', :locals => {
    :options => {
      :form_name => 'report',
      :url => request.query_parameters.merge(
        {:action => :create_weaknesses_by_state, :_ts => Time.now.to_i}
      ),
      :fields => [
        {
          :name => :report_title,
          :label => t('customize_report_form.title'),
          :value => t('execution_reports.weaknesses_by_state.title')
        }
      ]
    }
  } %>
  </div>
</div>
