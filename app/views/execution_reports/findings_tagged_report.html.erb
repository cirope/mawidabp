<% url = findings_tagged_report_path execution: params[:execution] %>

<div class="panel panel-default">
  <div class="panel-heading">
    <h4 class="panel-title"><%= t 'label.search' %></h4>
  </div>

  <div class="panel-body">
    <%= simple_form_for action_name, url: url, html: { method: :get, data: { no_observe_changes: true } } do |f| %>
      <% filters = %w[tags_count] %>
      <% filters.each do |filter_name| %>
        <%= render "shared/filters/#{filter_name}", f: f, display: true, action: action_name %>
      <% end %>


      <div class="form-actions">
        <%= hidden_field_tag :execution, params[:execution] %>
        <%= f.submit t('label.apply_filter'), class: 'btn btn-sm btn-default' %> |
        <%= link_to t('label.cancel'), url %>
      </div>
    <% end %>
  </div>
</div>

<% if @findings.present? %>
  <div class="well well-sm">
    <%= t '.findings_count_html', count: @findings.count %>
  </div>

  <table class="table table-condensed table-striped table-hover">
    <thead>
      <th><%= Organization.model_name.human %></th>
      <th><%= Review.model_name.human %></th>
      <th><%= BusinessUnitType.model_name.human %></th>
      <th><%= Finding.human_attribute_name(:review_code) %></th>
      <th><%= Finding.human_attribute_name(:title) %></th>
      <th><%= Finding.human_attribute_name(:state) %></th>
      <th><%= Finding.human_attribute_name(:auditors) %></th>
      <th><%= Tag.model_name.human(count: 0) %></th>
    </thead>

    <tbody>
      <% @findings.each do |finding| %>
        <tr>
          <td><%= finding.organization.prefix %></td>
          <td><%= finding.review.identification %></td>
          <td><%= finding.business_unit_type.name %></td>
          <td><%= finding.review_code %></td>
          <td><%= finding.title %></td>
          <td><%= finding.state_text %></td>
          <td><%= finding.users_that_can_act_as_audited.map(&:full_name).join('; ') %></td>
          <td><%= @ids_with_count[finding.id] %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <div class="alert alert-info">
    <%= t '.empty' %>
  </div>
<% end %>

<div>
  <%= link_to t('label.back'), action: :index %> |
  <%= link_to t('label.download'), '#', data: { toggle: 'modal', target: '#customize_report' } %>
</div>

<%= render partial: 'shared/customize_report_form', locals: {
  options: {
    form_name: 'report',
    url:       request.query_parameters.merge(action: :create_findings_tagged_report, _ts: Time.now.to_i),
    fields: [
      {
        name:  :report_title,
        label: t('customize_report_form.title'),
        value: @title
      }
    ]
  }
} %>
