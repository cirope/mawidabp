<%= render :partial => 'shared/filter_form',
  :locals => {:action => :weaknesses_by_audit_type, :extra_params => {},
  :forms => {:date_range => true}} %>

<% @periods.each do |period| -%>
  <h1 class="simple_title with_border_bottom">
    <strong><%= "#{Period.human_name}: #{period.inspect}" %></strong>
  </h1>
  <% @audit_types.each do |type| -%>
    <h1 class="center_title">
      <%= t("conclusion_committee_report.findings_type_#{type}") %>
    </h1>
    <% unless @data[period][type].blank? -%>
      <% @data[period][type].each do |data_item| -%>
        <div style="margin: 1em;">
          <h1><%= data_item[:title] %></h1>
          <% data_item[:business_units].each do |bu, bu_data| -%>
            <p>
              <b><%= bu.business_unit_type.business_unit_label %></b>:
              <%= bu.name %>
            </p>
            <p style="margin-top: 1em;">
              <strong><%= t(:'actioncontroller.reviews') %></strong>
            </p>
            <%= array_to_ul(
              audit_by_type_reviews_array(bu_data[:conclusion_reviews]),
              :class => :raw_list) %>

            <div style="margin-bottom: 1em;">
              <h2><%= t(:'follow_up_committee.weaknesses_by_audit_type.weaknesses') %></h2>
              <%= render :partial => 'weaknesses_synthesis_table', :locals => {
                :table_data => bu_data[:weaknesses_table_data],
                :being_implemented_resume => bu_data[:being_implemented_resume]} %>

              <% if type == :internal -%>
                <h2 style="margin-top: 1em;">
                  <%= t(:'follow_up_committee.weaknesses_by_audit_type.oportunities') %>
                </h2>
                <% unless bu_data[:oportunities_table_data].blank? -%>
                  <table class="summary_table" style="margin: 1em 0em;">
                    <thead>
                      <tr>
                        <th style="width: 30%;">
                          <%= Oportunity.human_attribute_name('state') %>
                        </th>
                        <th style="width: 70%;">
                          <%= Oportunity.human_attribute_name('count') %>
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <% bu_data[:oportunities_table_data].each do |data| -%>
                        <tr>
                          <td><strong><%= data['state'].to_utf8 %></strong></td>
                          <td><%= data['count'] %></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                <% else -%>
                  <p style="margin: 1em 0em; font-size: 1.1em;">
                    <em><%= t(:'follow_up_committee.without_oportunities') %></em>
                  </p>
                <% end -%>
              <% end -%>
            </div>
          <% end -%>
        </div>
      <% end -%>
    <% else -%>
      <p style="margin: 1em; font-size: 1.1em;">
        <em><%= t(:'follow_up_committee.without_weaknesses') %></em>
      </p>
    <% end -%>
  <% end -%>
<% end -%>

<div id="links">
  <%= link_to t(:'label.back'), :action => :index %> |
  <%= link_to_function t(:'label.download'),
    "Helper.showItem('customize_report_form')" %>
</div>
<div id="customize_report_form" style="display: none;">
  <div>
  <%= render :partial => 'shared/customize_report_form', :locals => {
    :options => {
      :form_name => 'report',
      :url => request.query_parameters.merge({:action => :create_weaknesses_by_audit_type}),
      :fields => [
        {
          :name => :report_title,
          :label => t(:'customize_report_form.title'),
          :value => t(:'follow_up_committee.weaknesses_by_audit_type.title')
        }
      ]
    }
  } %>
  </div>
</div>