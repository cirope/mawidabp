<script type="text/javascript">
  function autocompleteUserAndCost(text, li) {
    AutoComplete.itemSelected(text, li);

    var objectId = $(li).id.strip().match(/id_(\d+)$/)[1];
    var costPerUnit = $F("cost_of_" + objectId);
    var jumps = 0;
    var costField;

    do {
      costField = $(text).up('div.item_field').next('div.item_field',
        jumps++).down('input[name*=cost_per_unit]');
    } while(!costField);

    costField.setValue(costPerUnit);
  }
</script>
<!--[form:plan]-->
<%= form_for @plan do |p_f| %>
  <% content_for :js_extra do %>
    <%= raw "var plan_item='#{generate_template(p_f, :plan_items)}';" %>
  <% end %>
  <%= p_f.error_messages %>

  <div class="form_column_left">
    <% if @plan.new_record? %>
      <p class="form_item">
        <%= p_f.label :period_id, nil, :class => :inline %>
        <%= p_f.select :period_id,
          Period.list_all_without_plans.map { |p| [p.inspect, p.id] },
          {:prompt => true},
          {:class => 'inline_item focused'} %>
        <%= link_to_add new_period_path(:back_to => new_plan_path) %>
      </p>
    <% else %>
      <p class="form_item">
        <%= p_f.hidden_field :period_id %>
        <%= label_tag :period, Plan.human_attribute_name('period_id'),
          :class => :inline %>
        <%= text_field_tag :period, @plan.period.try(:inspect),
          :readonly => true, :class => :inline_item %>
      </p>
    <% end %>
  </div>
  <div class="form_column_right">
    <p>
      <%= Plan.human_attribute_name('estimated_amount') %>:
      <b><%= t(:'number.currency.format.unit') %><span id="estimated_amount"><%= '%.2f' % @plan.estimated_amount %></span></b>
      <%= link_to_function t(:'plan.calculate_estimated_amount'),
        "calculateEstimatedAmount()", :style => 'margin-left: .5em;' %>
    </p>
  </div>

  <div class="items">
    <div class="column_headers" style="padding-left: 2.1em;">
      <div class="item_column" style="width: 5%; padding-left: .3em;">
        <h3><%= PlanItem.human_attribute_name :order_number %></h3>
      </div>
      <div class="item_column" style="width: 20%; padding-left: .3em;">
        <h3><%= raw(BusinessUnit.model_name.human +
          show_inline_help_for(:plan_business_unit)) %></h3>
      </div>
      <div class="item_column" style="width: 20%; padding-left: .3em;">
        <h3><%= raw(PlanItem.human_attribute_name(:project) +
          show_inline_help_for(:plan_project)) %></h3>
      </div>
      <div class="item_column" style="width: 13%; padding-left: .3em;">
        <h3><%= raw(PlanItem.human_attribute_name(:start) +
          show_inline_help_for(:plan_start)) %></h3>
      </div>
      <div class="item_column" style="width: 13%; padding-left: .3em;">
        <h3><%= raw(PlanItem.human_attribute_name(:end) +
          show_inline_help_for(:plan_end)) %></h3>
      </div>
      <div class="item_column" style="width: 13%; padding-left: .3em;">
        <h3><%= PlanItem.human_attribute_name :predecessors %></h3>
      </div>
      <div class="item_column" style="width: 10%;"></div>
      <div class="clear"></div>
    </div>

    <div id="plan_items">
      <%= p_f.fields_for :plan_items, @plan.plan_items.sort do |pi_f| %>
        <% mru_template = nil %>
        <% content_for :js_extra do %>
          <% hru_template ||= generate_template(pi_f, :resource_utilizations,
            :object => ResourceUtilization.new(:resource_type => 'User'),
            :partial => 'human_resource_utilization',
            :child_index => 'NEW_SUBRECORD') %>
          <% mru_template ||= generate_template(pi_f, :resource_utilizations,
            :object => ResourceUtilization.new(:resource_type => 'Resource'),
            :partial => 'material_resource_utilization',
            :child_index => 'NEW_SUBRECORD') %>
          <%= raw "var material_resource_utilization = '#{mru_template}';" unless mru_template == 0 %>
          <%= raw "var human_resource_utilization = '#{hru_template}';" unless hru_template == 0 %>
          <% mru_template = 0 %>
          <% hru_template = 0 %>
        <% end %>
        <%= render :partial => 'plan_item', :locals =>
          {:f => pi_f, :is_dynamic => false} %>
      <% end %>
    </div>
  </div>

  <p class="add_item">
    <%= link_to t(:'plan.add_plan_item'), '#', :'data-template' => :plan_item,
      :'data-event' => :add_nested_item, :'data-container' => :plan_items %>
  </p>

  <% if @plan.has_duplication? %>
    <p class="form_item">
      <%= p_f.label :allow_duplication, t(:'plan.allow_duplication'),
        :class => 'inline error_field' %>
      <%= p_f.check_box :allow_duplication, :class => :inline_item %>
    </p>
  <% end %>

  <% if @plan.overloaded? %>
    <p class="form_item">
      <%= p_f.label :allow_overload, t(:'plan.allow_overload'),
        :class => 'inline error_field' %>
      <%= p_f.check_box :allow_overload, :class => :inline_item %>
    </p>
  <% end %>

  <%= hidden_lock_version(p_f) %>
  <p>
    <span class="button"><%= p_f.submit %></span>
  </p>
<% end %>
<!--[eoform:plan] -->
<%= set_focus_to_first_element %>
<script type="text/javascript">
  Helper.makeSortable('plan_items', '#plan_items div.plan_item', '#plan_items a.move');

  function calculateEstimatedAmount() {
    var estimatedElement = $('estimated_amount');
    var estimatedTotal = 0;

    $$('input[name*=cost_per_unit]').each(function(e) {
      var value = $F(e).sub(/^[^\d.]+/, '');
      var unitsString = $F($(e).up('div.item_field').previous(
        'div.item_field').down('input[name*=units]')).sub(/^[^\d.]+/, '');
      var units = unitsString.match(/^[.\d+]?\d+/) ?
        parseFloat(unitsString) : 0;

      estimatedTotal += value.match(/^[.\d+]?\d+/) ?
        parseFloat(value) * units : 0;
    });

    estimatedElement.update(estimatedTotal.toFixed(2));
    new Effect.Highlight(estimatedElement, {
      queue: { position: 'end', scope: 'plan_cost', limit: 1 }
    });
  }
</script>