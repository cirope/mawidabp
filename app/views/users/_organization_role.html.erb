<% id = dynamic_object_id('organization_role', f) %>
<% hide = is_dynamic || f.object.marked_for_destruction? %>
<% roles = f.object.organization ? Role.list_by_organization(
     f.object.organization.id) : [] %>
<div class="organization_role item" <%= raw 'style="display: none;"' if hide %> id="<%= id %>">
  <div>
    <div class="item_field" style="width: 40%;">
    <%= user_organizations_field(f, id) %>
    </div>
    <div class="item_field" style="width: 40%;">
    <%= f.select :role_id, sorted_options_array_for(roles, :name, :id),
      {:prompt => true},
      {:disabled => f.object.organization.nil?, :class => :role_select} %>
    </div>
    <div class="item_field item_controls" style="width: 10%;">
    <%= remove_item_link(f) %>
    </div>
  </div>
</div>
<% if is_dynamic %>
  <script type="text/javascript">Helper.showItem('#<%= id %>');</script>
<% end %>
  <script type="text/javascript">
    $('#<%= id %>_organization_id').change(function() {
      var element = $(this);
      var roleSelect = $('.role_select', element.parents('.organization_role'));

      if(!$(element).val().match(/^\s*$/)) {
        var url = '<%= url_for(:action => (@auth_user ? :roles : :initial_roles),
          :hash => params[:hash]) %>';

        Helper.showLoading(element);

        $.get(url, { id: $(element).val(), format: 'json' }, function(data) {
          HTMLUtil.updateOptions(
            roleSelect,
            HTMLUtil.optionsFromArray(data)
          );

          roleSelect.val('');
        }).complete(function() {
          Helper.hideLoading(element);
        });
      } else {
        roleSelect.html('');
        roleSelect.attr('disabled', true);
      }
    });
  </script>
