<%= render partial: 'shared/filter_form',
  locals: {
    action: :weaknesses_by_month, extra_params: {
      controller_name: 'follow_up', final: false
    },
    forms: { date_range: true, business_unit: true, finding: true, risk_levels: true }
  }
%>

<% @months.each do |month| %>
  <div class="page-header">
    <h2><%= l month, format: '%B %Y' %></h2>
  </div>

  <% if @reviews[month].present? %>
    <% last_shown_business_unit_type_id = nil %>

    <% @reviews[month].each do |data| %>
      <% conclusion_review = data[:conclusion_review] %>

      <% unless last_shown_business_unit_type_id == conclusion_review.review.business_unit_type.id %>
        <h3>
          <%= conclusion_review.review.business_unit_type.name %>
        </h3>

        <% last_shown_business_unit_type_id = conclusion_review.review.business_unit_type.id %>
      <% end %>

      <p>
        <strong><%= Review.human_attribute_name 'identification' %></strong>:
        <%= conclusion_review.review.identification %>
      </p>

      <p>
        <strong><%= ConclusionFinalReview.human_attribute_name 'issue_date' %></strong>:
        <%= l conclusion_review.issue_date %>
      </p>

      <p>
        <strong><%= BusinessUnit.model_name.human %></strong>:
        <%= conclusion_review.review.business_unit.name %>
      </p>

      <p>
        <strong><%= Review.human_attribute_name 'plan_item' %></strong>:
        <%= conclusion_review.review.plan_item.project %>
      </p>

      <p>
        <strong><%= ConclusionFinalReview.human_attribute_name 'conclusion' %></strong>:
        <%= conclusion_review.conclusion %>
      </p>

      <p>
        <strong><%= ConclusionFinalReview.human_attribute_name 'evolution' %></strong>:
        <%= conclusion_review.evolution %>
      </p>

      <p>
        <strong><%= Review.human_attribute_name 'risk_exposure' %></strong>:
        <%= conclusion_review.review.risk_exposure %>
      </p>

      <% weaknesses = data[:weaknesses] %>

      <p>
        <strong>
          <em><%= t 'follow_up_committee_report.weaknesses_by_month.main_weaknesses' %></em>
        </strong>
      </p>

      <% main_weaknesses = weaknesses.not_revoked.not_assumed_risk.with_high_risk.sort_by_code %>

      <% if main_weaknesses.any? %>
        <div style="margin-left: 2em;">
          <% main_weaknesses.each do |w| %>
            <p>
              <strong> <%= Weakness.human_attribute_name 'title' %></strong>:
              <%= w.title %>
            </p>

            <p>
              <strong><%= Weakness.human_attribute_name 'risk' %></strong>:
              <%= w.risk_text %>
            </p>

            <p>
              <strong><%= Weakness.human_attribute_name 'origination_date' %></strong>:
              <% if w.repeated_of_id %>
                <%= l w.origination_date, format: :long %>
              <% else %>
                <%= t 'conclusion_review.new_origination_date' %>
              <% end %>
            </p>

            <div>
              <strong><%= Weakness.human_attribute_name 'description' %></strong>:
              <%= simple_format w.description %>
            </div>

            <div>
              <strong><%= Weakness.human_attribute_name 'answer' %></strong>:
              <%= simple_format w.answer %>
            </div>

            <p>
              <strong><%= t 'conclusion_review.estimated_follow_up_date' %></strong>:
              <%= l w.follow_up_date, format: '%B %Y' if w.follow_up_date %>
            </p>

            <br>
          <% end %>
        </div>
      <% else %>
        <p><em><%= t 'follow_up_committee_report.weaknesses_by_month.without_weaknesses' %></em></p>
      <% end %>

      <p>
        <strong>
          <em><%= t 'follow_up_committee_report.weaknesses_by_month.other_weaknesses' %></em>
        </strong>
      </p>

      <% other_weaknesses = weaknesses.not_revoked.not_assumed_risk.with_other_risk.sort_by_code %>

      <% if other_weaknesses.any? %>
        <ul>
          <% other_weaknesses.each do |w| %>
            <li>
              <%=
                [
                  w.title,
                  [Weakness.human_attribute_name('risk'), w.risk_text].join(': '),
                  [
                    Weakness.human_attribute_name('origination_date'),
                    w.repeated_of_id ? l(w.origination_date) : t('conclusion_review.new_origination_date')
                  ].join(': '),
                  ([
                    t('follow_up_committee_report.weaknesses_by_month.year'),
                    l(w.origination_date, format: '%Y')
                  ].join(': ') if w.repeated_of_id)
                ].compact.join(' - ')
              %>
            </li>
          <% end %>
        </ul>
      <% else %>
        <div style="margin-left: 2em">
          <p><em><%= t 'follow_up_committee_report.weaknesses_by_month.without_weaknesses' %></em></p>
        </div>
      <% end %>

      <br>
    <% end %>
  <% else %>
    <p>
      <em><%= t 'follow_up_committee_report.weaknesses_by_month.without_audits_in_the_month' %></em>
    </p>
  <% end %>
<% end %>

<hr />

<div>
  <%= link_to t('label.back'), action: :index %> |
  <%= link_to t('label.download'), '#',
    data: { toggle: 'modal', target: "#customize_report" } %>
</div>

<%= render partial: 'shared/customize_report_form', locals: {
  options: {
    form_name: 'report',
    url: request.query_parameters.merge(
      {action: :create_weaknesses_by_month, _ts: Time.now.to_i}
    ),
    fields: [
      {
        name: :report_title,
        label: t('customize_report_form.title'),
        value: t('follow_up_committee_report.weaknesses_by_month.title')
      },
      {
        name: :report_subtitle,
        label: t('customize_report_form.subtitle'),
        value: t('follow_up_committee_report.weaknesses_by_month.subtitle')
      }
    ]
  }
} %>
