<% readonly = !@conclusion_final_review.new_record? %>

<%= simple_form_for @conclusion_final_review do |f| %>
  <%= render 'shared/error_explanation', f: f %>

  <div class="form-inputs">
    <div class="row">
      <div class="col-md-6">
        <% unless @conclusion_final_review.review %>
          <%= conclusion_final_review_review_field(f, @conclusion_final_review.review) %>
        <% else %>
          <%= f.input :review, label: ConclusionFinalReview.human_attribute_name(:review_id),
            input_html: { value: @conclusion_final_review.review.identification, readonly: true } %>
          <%= f.input :review_id, as: :hidden %>
        <% end %>
        <%= f.input :business_unit, input_html: {
          value: (@conclusion_final_review.review.business_unit.name if @conclusion_final_review.review),
          readonly: true } %>
        <%= f.input :project, input_html: {
          value: (@conclusion_final_review.review.plan_item.project if @conclusion_final_review.review),
          readonly: true } %>
        <%= f.input :applied_procedures, input_html: { readonly: readonly } %>
      </div>
      <div class="col-md-6">
        <%= f.input :conclusion, input_html: { readonly: readonly } %>
        <%= f.input :score, input_html: {
          value: (@conclusion_final_review.review.score_text if @conclusion_final_review.review),
          readonly: true } %>
        <%= f.input :issue_date, as: :date_picker, label: raw(
            ConclusionFinalReview.human_attribute_name(:issue_date) +
            show_inline_help_for(:conclusion_review_issue_date)),
            input_html: { readonly: readonly } %>
        <%= f.input :close_date, as: :date_picker, label: raw(
            ConclusionFinalReview.human_attribute_name(:close_date) +
            show_inline_help_for(:conclusion_review_close_date)),
            input_html: { readonly: readonly } %>
      </div>
    </div>
  </div>

  <hr />

  <div class="form-actions form-footer">
    <div class="pull-right"><%= yield :form_actions %></div>
    <%= f.input :lock_version, as: :hidden %>
    <%= f.submit class: 'btn btn-primary' %>
  </div>
<% end %>
<%= render :partial => 'shared/customize_report_form', :locals => {
  :options => {
    :form_name => 'bundle',
    :url => {
      :action => :create_bundle,
      :id => @conclusion_final_review,
      :_ts => Time.now.to_i
    },
    :fields => [
      {
        :name => :index_items,
        :label => t('conclusion_review.bundle_index.items_label'),
        :value => t('conclusion_review.bundle_index.default_items')
      }
    ],
    :submit_label => t('conclusion_review.bundle.create')
  }
} %>
<script type="text/javascript">
//<![CDATA[
  $('#conclusion_final_review_review_id').change(function() {
    var elementsForUpdate = ['applied_procedures', 'conclusion'];

    if(!$(this).val().match(/^\s*$/)) {
      var element = $(this);
      var url = '<%= new_conclusion_final_review_path :format => :json %>';

      Helper.showLoading(element);

      $.get(url, { review: element.val() }, function(data) {

        for(var key in data) {
          var target = $('#conclusion_final_review_' + key);

          if($.inArray(key, elementsForUpdate) != -1) {
            target.html(data[key] || '');
          }
        }

        $('#business_unit').val(data.review.business_unit.name);
        $('#project').val(data.review.plan_item.project);
        $('#score').val(data.review.score_text);
        $('#conclusion_final_review_applied_procedures').focus();
      }).complete(function() {
        Helper.hideLoading(element);
      });
    } else {
      $.each(elementsForUpdate, function(i, e) {
        $('#conclusion_final_review_' + e).html('');
      });

      $('#business_unit').val('');
      $('#project').val('');
      $('#score').val('');
    }
  });
//]]>
</script>
