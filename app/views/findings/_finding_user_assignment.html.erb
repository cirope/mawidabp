<% id = "#{dynamic_object_id('user', f)}_#{is_dynamic ? 'NEW_RECORD' : f.object.user_id}" %>
<% hide = is_dynamic || f.object.marked_for_destruction? %>
<% original_finding = @finding.errors.empty? ? @finding : Finding.find(@finding.id) %>
<% is_a_new_relation = original_finding.finding_user_assignments.detect { |fua| fua.user_id == f.object.user_id }.nil? %>
<div class="finding_user_assignment item" id="<%= id %>" <%= raw 'style="display: none;"' if hide %>>
  <div>
    <div class="item_field" style="width: 50%;">
      <% unless readonly %>
        <div class="search">
          <% field_classes = [:search, :autocomplete_field, :required] %>
          <% field_classes << :error_field unless (f.object.errors[:user_id] | f.object.errors[:user]).blank? %>
          <%= text_field_tag 'finding[nested_user]',
            f.object.user.try(:full_name_with_function),
            :id => "finding_user_#{id}",
            :class => field_classes.join(' '),
            :title => t(:'label.search'),
            :autocomplete => :off,
            :autofocus => true,
            :'data-autocomplete-params' => ("{finding_id: #{@finding.id}}" unless @finding.new_record?),
            :'data-autocomplete-url' => auto_complete_for_user_findings_path(:format => :json) %>
          <%= f.hidden_field :user_id, :value => f.object.user_id,
            :id => "hidden_user_id_#{id}", :class => :autocomplete_id %>
          <% if is_dynamic || is_a_new_relation %>
            <%= hidden_field_tag 'finding[users_for_notification][]', nil,
              :id => "hidden_user_for_notification_#{id}",
              :class => :user_for_notification %>
          <% end %>
        </div>
      <% else %>
        <%= f.hidden_field :user_id, :value => f.object.user_id,
          :id => "hidden_user_id_#{id}" %>
        <%= text_field_tag "finding_user_#{id}",
          f.object.user.try(:full_name_with_function, f.object.created_at), :readonly => true %>
      <% end %>
    </div>
    <div class="item_field" style="width: 15%;">
      <%= f.check_box :process_owner, :disabled => f.object.user && !f.object.user.can_act_as_audited? %>
    </div>
    <div class="item_field" style="width: 15%;">
      <% if is_dynamic || is_a_new_relation %>
        <%= check_box_tag "user_for_notification", '1', false,
          :class => :user_for_notification_selector %>
      <% else %>
        --
      <% end %>
    </div>
    <div class="item_field item_controls" style="width: 5%;">
      <%= remove_item_link(f) unless readonly %>
    </div>
  </div>
</div>
<% if is_dynamic %>
  <script type="text/javascript">
    Helper.showItem('#<%= id %>');
    AutoComplete.observeAll();
  </script>
<% end %>
