<% users_readonly = @finding.implemented_audited? || @finding.assumed_risk? -%>
<% show_history_changes = @finding.status_change_history.size > 1 -%>
<!--[form:finding]-->
<% form_for :finding, @finding, :url => finding_path(params[:completed], @finding), :html =>
  {:method => :put, :class => 'edit_finding', :multipart => true,
  :id => "edit_finding_#{@finding.id}"} do |f_f| -%>
  <% content_for :js_extra do -%>
    <%= "var finding_answer='#{generate_template(f_f, :finding_answers,
      :object => FindingAnswer.new(:user_id => @auth_user.id))}';" %>
    <%= "var finding_relation='#{generate_template(f_f, :finding_relations,
      :object => FindingRelation.new(:finding_id => @finding.id))}';" %>
    <%= "var work_paper='#{generate_template(f_f, :work_papers,
          {:form_builder_local => :wp_f,
          :partial => 'work_papers/work_paper',
          :locals => {:child_index => 'NEW_RECORD', :frozen => false},
          :object => WorkPaper.new(:organization_id => @auth_organization.id)})}';" %>
    <%= "var lastWorkPaperCode = '#{next_weakness_work_paper_code(
        @finding, true) if @finding.kind_of?(Weakness)}';" %>
    <%= "var finding_user_assignment='#{generate_template(f_f,
        :finding_user_assignments, :locals => {:readonly => users_readonly})}';" %>
  <% end -%>
  <%= f_f.error_messages %>

  <div class="form_column_left">
    <p class="form_item">
      <%= content_tag :label, Review.human_name, :class => :inline %>
      <%= text_field_tag :review, @finding.review.try(:identification),
        :class => :inline_item, :readonly => true %>
    </p>
    <p class="form_item">
      <%= content_tag :label, PlanItem.human_attribute_name(:project),
        :class => :inline %>
      <%= text_field_tag :project, @finding.review.try(:plan_item).try(:project),
        :class => :inline_item, :readonly => true %>
    </p>
    <p class="form_item">
      <%= f_f.label :review_code, nil, :class => :inline %>
      <%= f_f.text_field :review_code, :class => :inline_item, :size => nil,
        :readonly => true %>
    </p>
    <p class="form_item">
      <%= content_tag :label,
        ConclusionFinalReview.human_attribute_name(:issue_date) +
        show_inline_help_for(:finding_issue_date),
        :class => :inline %>
      <%= text_field_tag :issue_date, @finding.issue_date ?
        l(@finding.issue_date, :format => :long) :
        t(:'finding.without_conclusion_final_review'),
        :class => :inline_item, :readonly => true %>
    </p>
    <% if @finding.control_objective_item -%>
      <p>
        <label><%= ControlObjective.human_name %>:</label>
        <%= text_area nil, :control_objective_name, :size => nil,
          :value => "#{@finding.control_objective_item.control_objective_text} (#{@finding.control_objective_item.process_control.name})",
          :readonly => true %>
        <%= f_f.hidden_field :control_objective_item_id %>
      </p>
    <% end -%>
    <p>
      <%= f_f.label :description %>
      <%= f_f.text_area :description, :readonly => true, :style => 'height: 18.5em;' %>
    </p>
    <% if @finding.kind_of? Weakness -%>
      <p>
        <%= f_f.label :audit_recommendations %>
        <%= f_f.text_area :audit_recommendations, :size => nil,
          :readonly => true %>
      </p>
    <% end -%>
  </div>
  <div class="form_column_right">
    <% if @finding.kind_of? Weakness -%>
      <p class="form_item">
        <%= f_f.label :risk, nil, :class => :inline %>
        <%= f_f.select :risk, parameter_in(@auth_organization.id,
          :admin_finding_risk_levels, @finding.created_at, true),
          {:prompt => true}, {:class => :inline_item} %>
      </p>
      <p class="form_item">
        <%= f_f.label :priority, nil, :class => :inline %>
        <%= f_f.select :priority, parameter_in(@auth_organization.id,
          :admin_priorities, @finding.created_at, true),
          {:prompt => true}, {:class => :inline_item} %>
      </p>
    <% end -%>
    <p class="form_item">
      <%= f_f.label :state, Finding.human_attribute_name(:state) +
        show_inline_help_for(:finding_state) +
        (show_history_changes ? finding_show_status_change_history(
          :finding_status_change_history) : ''), :class => :inline %>
      <%= finding_status_field(f_f) %>
    </p>
    
    <% if show_history_changes -%>
      <%= render :partial => 'history_changes',
        :locals => { :finding => @finding } %>
    <% end -%>

    <% if @finding.must_have_a_comment? -%>
      <% f_f.fields_for :comments,
        @finding.comments.build(:user => @auth_user) do |c_f| -%>
        <p>
          <%= c_f.label :comment, nil, :class => :error_field %>
          <%= c_f.text_area :comment, :class => :error_field %>
          <%= c_f.hidden_field :user_id %>
        </p>
      <% end -%>
    <% end -%>
    <p>
      <%= f_f.label :origination_date,
        Finding.human_attribute_name(:origination_date) +
        show_inline_help_for(:finding_origination_date) %>
      <%= f_f.calendar_date_select :origination_date %>
    </p>
    <% if @finding.kind_of? Weakness -%>
      <p>
        <%= f_f.label :follow_up_date,
          Finding.human_attribute_name(:follow_up_date) +
          show_inline_help_for(:finding_follow_up_date) %>
        <%= f_f.calendar_date_select :follow_up_date %>
      </p>
      <%= show_weakness_previous_follow_up_dates @finding %>
    <% end -%>
    <p>
      <%= f_f.label :solution_date,
        Finding.human_attribute_name(:solution_date) +
        show_inline_help_for(:finding_solution_date) %>
      <%= f_f.calendar_date_select :solution_date %>
      <%= f_f.hidden_field :id %>
    </p>
    <p>
      <%= f_f.label :effect %>
      <%= f_f.text_area :effect, :readonly => true %>
    </p>
    <p>
      <%= f_f.label :answer %>
      <%= f_f.text_area :answer %>
    </p>
    <p>
      <%= f_f.label :audit_comments %>
      <%= f_f.text_area :audit_comments %>
    </p>
  </div>

  <% unless @finding.important_dates.blank? -%>
    <h1 style="clear: both;">
      <%= t(:'finding.important_dates.title') %>
      <%= show_inline_help_for(:finding_important_dates) %>
    </h1>
    <ul class="raw_list">
      <% @finding.important_dates.each do |important_date| -%>
        <li><%= textilize_without_paragraph important_date %></li>
      <% end -%>
    </ul>
  <% end -%>

  <div>
    <h1 style="clear: both;">
      <%= t(:'finding.responsibles', :count => @finding.users.size) %>
    </h1>

    <div class="column_headers">
      <div class="item_column" style="width: 50%;">
        <h3><%= User.human_name %></h3>
      </div>
      <div class="item_column" style="width: 15%;">
        <h3><%= t(:'finding.send_notification') %></h3>
      </div>
      <div class="item_column" style="width: 5%;"></div>
      <div style="clear: both;"></div>
    </div>

    <div id="finding_user_assignments">
      <% f_f.fields_for :finding_user_assignments do |fua_f| -%>
        <%= render :partial => 'finding_user_assignment', :locals =>
          {:f => fua_f, :is_dynamic => false, :readonly => users_readonly} %>
      <% end -%>
    </div>

    <p class="add_item">
      <%= link_to_unless users_readonly, t(:'finding.add_user'),
        '#finding_user_assignment', :class => :add_nested_item,
        :rel => :finding_user_assignments %>
    </p>
  </div>

  <div style="clear: both; margin-top: 2em;">
    <h1>
      <%= t(:'finding.finding_relations') %>
      <%= show_inline_help_for(:finding_relations) %>
    </h1>

    <div class="column_headers">
      <div class="item_column" style="width: 60%;">
        <h3><%= FindingRelation.human_attribute_name :related_finding_id %></h3>
      </div>
      <div class="item_column" style="width: 30%;">
        <h3><%= FindingRelation.human_attribute_name :finding_relation_type %></h3>
      </div>
      <div class="item_column" style="width: 5%;"></div>
      <div style="clear: both;"></div>
    </div>

    <div id="finding_relations">
      <% f_f.fields_for :finding_relations do |fr_f| -%>
        <%= render :partial => 'finding_relation', :locals =>
          {:f => fr_f, :is_dynamic => false} %>
      <% end -%>
    </div>
  </div>

  <p class="add_item">
    <%= link_to t(:'finding.add_finding_relation'), '#finding_relation',
      :class => :add_nested_item, :rel => :finding_relations %>
  </p>

  <div style="clear: both; margin-top: 2em;">
    <h1>
      <%= t(:'finding.finding_answers') %>
      <%= show_inline_help_for(:finding_comments) %>
    </h1>
    
    <div class="column_headers">
      <div class="item_column" style="width: 20%;">
        <h3><%= User.human_name %></h3>
      </div>
      <div class="item_column" style="width: 20%;">
        <h3><%= FindingAnswer.human_attribute_name :answer %></h3>
      </div>
      <div class="item_column" style="width: 20%;">
        <h3>
          <%= FindingAnswer.human_attribute_name :answer_type %>
          <%= show_inline_help_for(:finding_answer_type) %>
        </h3>
      </div>
      <div class="item_column" style="width: 10%;">
        <h3>
          <%= FindingAnswer.human_attribute_name :file_model %>
          <%= show_inline_help_for(:finding_file_model) %>
        </h3>
      </div>
      <div class="item_column" style="width: 20%;">
        <h3><%= FindingAnswer.human_attribute_name :created_at %></h3>
      </div>
      <div class="item_column" style="width: 5%;"></div>
      <div style="clear: both;"></div>
    </div>
    
    <div id="finding_answers">
      <% f_f.fields_for :finding_answers do |fa_f| -%>
        <%= render :partial => 'finding_answer', :locals =>
          {:f => fa_f, :is_dynamic => false} %>
      <% end -%>
    </div>
  </div>

  <p class="add_item">
    <%= link_to t(:'finding.add_finding_answer'), '#finding_answer',
      :class => :add_nested_item, :rel => :finding_answers %>
  </p>

  <div style="margin-top: 2em;">
    <h1><%= t(:'finding.work_papers') %></h1>
    
    <div class="column_headers">
      <div class="item_column" style="width: 20%;">
        <h3><%= WorkPaper.human_attribute_name :name %></h3>
      </div>
      <div class="item_column" style="width: 20%;">
        <h3><%= WorkPaper.human_attribute_name :code %></h3>
      </div>
      <div class="item_column" style="width: 15%;">
        <h3><%= WorkPaper.human_attribute_name :number_of_pages %></h3>
      </div>
      <div class="item_column" style="width: 25%;">
        <h3><%= WorkPaper.human_attribute_name :description %></h3>
      </div>
      <div class="item_column" style="width: 10%;">
        <h3><%= WorkPaper.human_attribute_name :file_model %></h3>
      </div>
      <div class="item_column" style="width: 10%;"></div>
      <div style="clear: both;"></div>
    </div>

    <div id="work_papers">
      <% f_f.fields_for :work_papers do |wp_f| -%>
        <%= render :partial => 'work_papers/work_paper', :locals =>
          {:wp_f => wp_f, :is_dynamic => false, :frozen => false,
          :child_index => 'NEW_RECORD'} %>
      <% end -%>
    </div>

    <p class="add_item">
      <%= link_to t(:'finding.add_work_paper'), '#work_paper',
        :class => :add_nested_item, :rel => :work_papers %>
    </p>
  </div>

  <div style="clear: both; margin-top: 2em;">
    <div class="title" style="font-weight: normal;">
      <%= textilize t(:'finding.costs',
        :cost => time_in_words_with_acronym((@finding.cost || 0).hours)) %>
    </div>

    <% unless @finding.costs.blank? -%>
      <p style="margin-bottom: 1em;">
        <%= link_to_function t(:'finding.view_cost_details'),
          "Effect.toggle('cost_details', 'slide')" %>
      </p>
      <div id="cost_details" style="display: none;">
        <div>
          <table class="summary_table">
            <thead>
              <tr>
                <th><%= Cost.human_attribute_name :created_at %></th>
                <th><%= Cost.human_attribute_name :cost %></th>
                <th><%= Cost.human_attribute_name :description %></th>
                <th><%= Cost.human_attribute_name :user_id %></th>
              </tr>
            </thead>
            <tbody>
              <% @finding.costs.reject {|f| f.new_record?}.each do |cost| -%>
                <tr>
                  <td><%= l(cost.created_at, :format => :long) %></td>
                  <td><%= time_in_words_with_acronym(cost.cost.hours) %></td>
                  <td><%= h cost.description.blank? ? '-' : cost.description %></td>
                  <td><%= h cost.user.full_name %></td>
                </tr>
              <% end -%>
            </tbody>
          </table>
        </div>
      </div>
    <% end -%>

    <div class="column_headers">
      <div class="item_column" style="width: 20%;">
        <h3>
          <%= Cost.human_attribute_name :cost %>
          <%= show_inline_help_for(:finding_cost_input) %>
        </h3>
      </div>
      <div class="item_column" style="width: 75%;">
        <h3><%= Cost.human_attribute_name :description %></h3>
      </div>
      <div style="clear: both;"></div>
    </div>

    <div id="costs">
      <% f_f.fields_for :costs, @finding.costs.detect { |c| c.new_record? } ||
          Cost.new(:user => @auth_user, :cost_type => 'audit') do |c_f| -%>
        <%= render :partial => 'cost', :locals => {:f => c_f} %>
      <% end -%>
    </div>
  </div>

  <div style="display:none">
  <%= f_f.hidden_field :lock_version %>
  </div>
  
  <p>
    <span class="button"><%= f_f.submit submit_button_text %></span>
  </p>
<% end -%>
<!--[eoform:finding] -->
<%= set_focus_to_first_element %>
<%= javascript_tag 'HTMLUtil.stylizeAllInputFiles();' %>
<script type="text/javascript">
  Event.observe('app_content', 'click', function(event) {
    var e = Event.findElement(event);

    if(e.hasClassName('user_for_notification_selector')) {
      var id = $F(e.up('.finding_user_assignment').down('.autocomplete_id_item'));
      var userField = e.up('.finding_user_assignment').down(
      '.user_for_notification');

      if(e.checked) {
        userField.setValue(id);
        userField.addClassName('autocomplete_id_item');
      } else {
        userField.setValue('');
        userField.removeClassName('autocomplete_id_item');
      }
    }
  });
</script>