jQuery ($) ->
  $(document).on 'change', '[data-repeated-url]', ->
    repeatedSelect = $(this)
    repeatedId     = repeatedSelect.val()
    urlTemplate    = decodeURI repeatedSelect.data('repeatedUrl')
    url            = urlTemplate.replace '[FINDING_ID]', repeatedId
    fields         = [
      'title', 'description', 'effect', 'audit_recommendations', 'risk',
      'priority', 'answer', 'audit_comments'
    ]

    if repeatedId
      repeatedSelect.prop 'disabled', true

      $.getJSON url, (finding) ->
        $.each fields, (i, field) ->
          $("[name$=\"[#{field}]\"]").val finding[field]

        followUpDate = new Date finding['follow_up_date']

        followUpDate.setMinutes new Date().getTimezoneOffset()
        $('[name$="[follow_up_date]"]').datepicker()
        $('[name$="[follow_up_date]"]').datepicker('setDate', followUpDate)
      .always -> repeatedSelect.prop 'disabled', false
    else
      $.each fields, (i, field) -> $("[name$=\"[#{field}]\"]").val ''
